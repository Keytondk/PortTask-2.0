# HashiCorp Vault integration using External Secrets Operator
# Prerequisites:
#   1. Install External Secrets Operator: helm install external-secrets external-secrets/external-secrets -n external-secrets --create-namespace
#   2. Set up HashiCorp Vault (self-hosted or HCP Vault)
#   3. Configure Vault Kubernetes auth method
#
# Usage:
#   kubectl apply -f vault-secrets-store.yaml
---
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: vault-backend
spec:
  provider:
    vault:
      server: "https://vault.example.com"  # Replace with your Vault address
      path: "secret"
      version: "v2"
      # Kubernetes authentication (recommended)
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "navo-app"
          serviceAccountRef:
            name: vault-auth-sa
            namespace: external-secrets
      # Alternative: Token authentication (not recommended for production)
      # auth:
      #   tokenSecretRef:
      #     name: vault-token
      #     key: token
      #     namespace: external-secrets
---
# Service account for Vault authentication
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vault-auth-sa
  namespace: external-secrets
---
# External Secret for Navo application secrets from Vault
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: navo-secrets
  namespace: navo
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: navo-secrets
    creationPolicy: Owner
  data:
    - secretKey: JWT_SECRET
      remoteRef:
        key: navo/data/secrets
        property: jwt_secret
    - secretKey: DB_PASSWORD
      remoteRef:
        key: navo/data/database
        property: password
    - secretKey: SMTP_PASSWORD
      remoteRef:
        key: navo/data/smtp
        property: password
    - secretKey: AIS_API_KEY
      remoteRef:
        key: navo/data/integrations
        property: ais_api_key
---
# External Secret for database connection strings from Vault
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: navo-db-secrets
  namespace: navo
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: navo-db-secrets
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        # Construct DATABASE_URL from individual components
        DATABASE_URL: "postgresql://{{ .db_user }}:{{ .db_password }}@{{ .db_host }}:{{ .db_port }}/{{ .db_name }}?sslmode=require"
        REDIS_URL: "redis://:{{ .redis_password }}@{{ .redis_host }}:{{ .redis_port }}"
  data:
    - secretKey: db_user
      remoteRef:
        key: navo/data/database
        property: username
    - secretKey: db_password
      remoteRef:
        key: navo/data/database
        property: password
    - secretKey: db_host
      remoteRef:
        key: navo/data/database
        property: host
    - secretKey: db_port
      remoteRef:
        key: navo/data/database
        property: port
    - secretKey: db_name
      remoteRef:
        key: navo/data/database
        property: name
    - secretKey: redis_host
      remoteRef:
        key: navo/data/redis
        property: host
    - secretKey: redis_port
      remoteRef:
        key: navo/data/redis
        property: port
    - secretKey: redis_password
      remoteRef:
        key: navo/data/redis
        property: password
