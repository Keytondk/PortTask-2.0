# AWS Secrets Manager integration using External Secrets Operator
# Prerequisites:
#   1. Install External Secrets Operator: helm install external-secrets external-secrets/external-secrets -n external-secrets --create-namespace
#   2. Create IAM role with SecretsManager read access
#   3. Set up IRSA (IAM Roles for Service Accounts) or provide AWS credentials
#
# Usage:
#   kubectl apply -f aws-secrets-store.yaml
---
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: aws-secrets-manager
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-east-1  # Change to your region
      # Option 1: Use IRSA (recommended for EKS)
      auth:
        jwt:
          serviceAccountRef:
            name: external-secrets-sa
            namespace: external-secrets
      # Option 2: Use static credentials (not recommended for production)
      # auth:
      #   secretRef:
      #     accessKeyIDSecretRef:
      #       name: aws-credentials
      #       key: access-key-id
      #       namespace: external-secrets
      #     secretAccessKeySecretRef:
      #       name: aws-credentials
      #       key: secret-access-key
      #       namespace: external-secrets
---
# Service account for IRSA
apiVersion: v1
kind: ServiceAccount
metadata:
  name: external-secrets-sa
  namespace: external-secrets
  annotations:
    # Replace with your IAM role ARN
    eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/navo-external-secrets-role
---
# External Secret for Navo application secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: navo-secrets
  namespace: navo
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: navo-secrets
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        JWT_SECRET: "{{ .jwt_secret }}"
        DB_PASSWORD: "{{ .db_password }}"
        SMTP_PASSWORD: "{{ .smtp_password }}"
        AIS_API_KEY: "{{ .ais_api_key }}"
        AWS_ACCESS_KEY_ID: "{{ .aws_access_key_id }}"
        AWS_SECRET_ACCESS_KEY: "{{ .aws_secret_access_key }}"
  data:
    - secretKey: jwt_secret
      remoteRef:
        key: navo/production/secrets
        property: jwt_secret
    - secretKey: db_password
      remoteRef:
        key: navo/production/secrets
        property: db_password
    - secretKey: smtp_password
      remoteRef:
        key: navo/production/secrets
        property: smtp_password
    - secretKey: ais_api_key
      remoteRef:
        key: navo/production/secrets
        property: ais_api_key
    - secretKey: aws_access_key_id
      remoteRef:
        key: navo/production/secrets
        property: aws_access_key_id
    - secretKey: aws_secret_access_key
      remoteRef:
        key: navo/production/secrets
        property: aws_secret_access_key
---
# External Secret for database credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: navo-db-secrets
  namespace: navo
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: navo-db-secrets
    creationPolicy: Owner
  data:
    - secretKey: DATABASE_URL
      remoteRef:
        key: navo/production/database
        property: connection_string
    - secretKey: REDIS_URL
      remoteRef:
        key: navo/production/redis
        property: connection_string
